
type TabelaFlecha = Record<number, Record<number, number>>;

const tabelaBT: TabelaFlecha = {
  0: { 5: 1, 10: 4, 15: 10, 20: 17, 25: 27, 30: 39, 35: 53, 40: 69, 45: 87 },
  5: { 5: 1, 10: 5, 15: 11, 20: 19, 25: 30, 30: 42, 35: 56, 40: 73, 45: 91 },
  10: { 5: 2, 10: 6, 15: 13, 20: 22, 25: 32, 30: 45, 35: 60, 40: 76, 45: 95 },
  15: { 5: 2, 10: 7, 15: 15, 20: 24, 25: 35, 30: 48, 35: 63, 40: 80, 45: 99 },
  20: { 5: 3, 10: 9, 15: 17, 20: 26, 25: 38, 30: 51, 35: 66, 40: 83, 45: 102 },
  25: { 5: 4, 10: 10, 15: 18, 20: 28, 25: 40, 30: 54, 35: 69, 40: 87, 45: 106 },
  30: { 5: 5, 10: 12, 15: 20, 20: 31, 25: 43, 30: 57, 35: 72, 40: 90, 45: 109 },
  35: { 5: 6, 10: 13, 15: 22, 20: 33, 25: 45, 30: 59, 35: 75, 40: 93, 45: 113 },
  40: { 5: 6, 10: 14, 15: 24, 20: 35, 25: 48, 30: 62, 35: 78, 40: 96, 45: 116 },
  45: { 5: 7, 10: 16, 15: 26, 20: 37, 25: 50, 30: 65, 35: 81, 40: 98, 45: 120 },
  50: { 5: 8, 10: 17, 15: 27, 20: 39, 25: 52, 30: 67, 35: 84, 40: 102, 45: 123 },
};

const tabelaMT_4: TabelaFlecha = {
  10: { 10: 1, 15: 3, 20: 5, 25: 8, 30: 12, 35: 17, 40: 24, 45: 32 },
  15: { 10: 1, 15: 3, 20: 6, 25: 9, 30: 14, 35: 20, 40: 28, 45: 37 },
  20: { 10: 2, 15: 4, 20: 7, 25: 12, 30: 17, 35: 24, 40: 32, 45: 42 },
  25: { 10: 2, 15: 5, 20: 9, 25: 15, 30: 21, 35: 29, 40: 37, 45: 47 },
  30: { 10: 3, 15: 7, 20: 12, 25: 18, 30: 25, 35: 33, 40: 42, 45: 52 },
  35: { 10: 5, 15: 10, 20: 15, 25: 22, 30: 29, 35: 38, 40: 47, 45: 58 },
  40: { 10: 7, 15: 12, 20: 18, 25: 25, 30: 33, 35: 42, 40: 52, 45: 63 },
};

const tabelaMT_1_0: TabelaFlecha = {
  10: { 10: 1, 15: 3, 20: 6, 25: 10, 30: 16, 35: 25, 40: 35, 45: 48 },
  15: { 10: 2, 15: 4, 20: 7, 25: 13, 30: 20, 35: 29, 40: 40, 45: 53 },
  20: { 10: 2, 15: 5, 20: 10, 25: 16, 30: 24, 35: 34, 40: 45, 45: 58 },
  25: { 10: 3, 15: 7, 20: 12, 25: 19, 30: 28, 35: 38, 40: 50, 45: 63 },
  30: { 10: 5, 15: 9, 20: 16, 25: 23, 30: 32, 35: 42, 40: 54, 45: 68 },
  35: { 10: 7, 15: 12, 20: 19, 25: 27, 30: 36, 35: 47, 40: 59, 45: 72 },
  40: { 10: 8, 15: 14, 20: 22, 25: 30, 30: 39, 35: 50, 40: 63, 45: 77 },
};

const tabelaMT_2_0: TabelaFlecha = {
  10: { 10: 1, 15: 3, 20: 6, 25: 10, 30: 17, 35: 25, 40: 36, 45: 49 },
  15: { 10: 2, 15: 4, 20: 8, 25: 13, 30: 20, 35: 30, 40: 41, 45: 54 },
  20: { 10: 2, 15: 5, 20: 10, 25: 16, 30: 24, 35: 34, 40: 46, 45: 59 },
  25: { 10: 3, 15: 7, 20: 13, 25: 20, 30: 29, 35: 39, 40: 51, 45: 64 },
  30: { 10: 5, 15: 10, 20: 16, 25: 23, 30: 33, 35: 43, 40: 55, 45: 69 },
  35: { 10: 7, 15: 12, 20: 19, 25: 27, 30: 36, 35: 47, 40: 60, 45: 73 },
  40: { 10: 9, 15: 15, 20: 22, 25: 30, 30: 40, 35: 51, 40: 64, 45: 78 },
};

const tabelaMT_266: TabelaFlecha = {
  10: { 10: 1, 15: 3, 20: 6, 25: 11, 30: 17, 35: 26, 40: 36, 45: 49 },
  15: { 10: 2, 15: 4, 20: 8, 25: 13, 30: 21, 35: 30, 40: 41, 45: 54 },
  20: { 10: 2, 15: 5, 20: 10, 25: 16, 30: 25, 35: 35, 40: 46, 45: 60 },
  25: { 10: 3, 15: 7, 20: 13, 25: 20, 30: 29, 35: 39, 40: 51, 45: 64 },
  30: { 10: 5, 15: 10, 20: 16, 25: 23, 30: 33, 35: 43, 40: 55, 45: 69 },
  35: { 10: 7, 15: 12, 20: 19, 25: 27, 30: 36, 35: 47, 40: 60, 45: 74 },
  40: { 10: 9, 15: 15, 20: 22, 25: 30, 30: 40, 35: 51, 40: 64, 45: 78 },
};

const tabelaMT_336: TabelaFlecha = {
  10: { 10: 1, 15: 3, 20: 6, 25: 10, 30: 17, 35: 25, 40: 35, 45: 48 },
  15: { 10: 2, 15: 4, 20: 8, 25: 13, 30: 20, 35: 29, 40: 40, 45: 53 },
  20: { 10: 2, 15: 5, 20: 10, 25: 16, 30: 24, 35: 34, 40: 45, 45: 58 },
  25: { 10: 3, 15: 7, 20: 13, 25: 20, 30: 28, 35: 38, 40: 50, 45: 63 },
  30: { 10: 5, 15: 9, 20: 16, 25: 23, 30: 32, 35: 43, 40: 55, 45: 68 },
  35: { 10: 7, 15: 12, 20: 19, 25: 27, 30: 36, 35: 47, 40: 59, 45: 73 },
  40: { 10: 9, 15: 14, 20: 22, 25: 30, 30: 40, 35: 51, 40: 63, 45: 77 },
};

export const tabelas: {
  bt: TabelaFlecha;
  mt: Record<string, TabelaFlecha>;
} = {
  bt: tabelaBT,
  mt: {
    "4AWG CAA ou 4AWG CAA/AW": tabelaMT_4,
    "1/0AWG CAA ou 1/0AWG CAA/AW": tabelaMT_1_0,
    "2/0AWG CAA": tabelaMT_2_0,
    "266,8MCM CAA ou 266,8MCM CAA/AW": tabelaMT_266,
    "336,4MCM CAA": tabelaMT_336,
  },
};

export function getFlecha(temperatura: number, vao: number, tipo: 'bt' | 'mt', caboId?: string): number | null {
  let tabela: TabelaFlecha | undefined;

  if (tipo === 'bt') {
    tabela = tabelas.bt;
  } else if (tipo === 'mt' && caboId) {
    tabela = tabelas.mt[caboId];
  }

  if (!tabela) {
    return null;
  }

  const temperaturas = Object.keys(tabela).map(Number).sort((a, b) => a - b);
  // Assumindo que todas as linhas de temperatura têm as mesmas colunas de vão, pegamos da primeira
  const primeiraTemp = temperaturas[0];
  const vaos = Object.keys(tabela[primeiraTemp]).map(Number).sort((a, b) => a - b);

  // Encontrar a temperatura mais próxima
  const tempMaisProxima = temperaturas.reduce((prev, curr) => {
    return (Math.abs(curr - temperatura) < Math.abs(prev - temperatura) ? curr : prev);
  });

  // Encontrar o vão mais próximo
  const vaoMaisProximo = vaos.find(v => v >= vao) ?? vaos[vaos.length - 1];

  console.log(tabela[tempMaisProxima]?.[vaoMaisProximo])

  return tabela[tempMaisProxima]?.[vaoMaisProximo] ?? null;
}
